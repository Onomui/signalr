@using BadNews.Elevation
@model BadNews.Models.News.FullArticleModel

<main role="main" class="container">
    <div class="row">
        <div class="col-md-8 news-main">
            <div class="news-article">
                <h4 class="news-article-title">@Model.Article.Header</h4>
                <p class="news-article-meta">
                    @Model.Article.Date.ToString("d MMM yyyy", ViewBag.Culture)
                </p>
                @if (ViewContext.IsElevated())
                {
                    <form class="mb-4" onsubmit="return confirm('Удалить новость?')"
                          asp-controller="Editor"
                          asp-action="DeleteArticle"
                          asp-route-id="@(Model.Article.Id)">
                        <button type="submit" class="btn-danger">Удалить</button>
                    </form>
                }
                @Html.Raw(Model.Article.ContentHtml)
            </div>
        </div>

        <div id="comments"></div>

        <label>
            Пользователь <input id="userInput" />
        </label>
        <label>
            Комментарий <input id="commentInput" />
        </label>
        <div>
            <button id="sendButton">Отправить</button>
        </div>

        <aside class="col-md-4 news-sidebar">
            <vc:weather></vc:weather>
            <vc:archive-links></vc:archive-links>
        </aside>
    </div>
</main>

<footer class="news-footer">
    <p>
        <a href="#">Наверх</a>
    </p>
</footer>

<script src="/lib/jquery/dist/jquery.min.js"></script>
<script src="/js/signalr/dist/browser/signalr.js"></script>
<script type="text/javascript">
    $(function () {
        var articleId = '@Model.Article.Id';

        $.get('/api/news/' + articleId + '/comments', function (data) {
            var commentsDiv = document.getElementById('comments');

            var comments = data.comments || data.Comments || [];

            comments.forEach(function (comment) {
                var li = document.createElement('li');
                var user = comment.user || comment.User;
                var value = comment.value || comment.Value;
                li.textContent = user + ' говорит: ' + value;
                commentsDiv.appendChild(li);
            });
        });

        var connection = new signalR.HubConnectionBuilder()
            .withUrl('/commentsHub')
            .build();

        var sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        connection.on('ReceiveComment', function (user, message) {
            var li = document.createElement('li');
            li.textContent = user + ' говорит: ' + message;
            document.getElementById('comments').appendChild(li);
        });

        connection.start().then(function () {
            sendButton.disabled = false;
        }).catch(function (err) {
            console.error(err.toString());
        });

        sendButton.addEventListener('click', function (event) {
            var user = document.getElementById('userInput').value;
            var message = document.getElementById('commentInput').value;

            connection.invoke('SendComment', user, message)
                .catch(function (err) {
                    console.error(err.toString());
                });

            event.preventDefault();
        });
    });
</script>
